@using MP_VendorTool.Common;
@using MP_VendorTool.Models.Order
@{
    ViewBag.Title = "Quản lý chương trình Push Sale NCC";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/maincontent.css" rel="stylesheet" />
<style>
    label {
        font-weight: 400 !important;
    }

    .btn_detail {
        padding: 4px 1px;
        color: #525252;
        font-size: 11px;
        border-radius: 69px;
        border: 1px solid #ffffff;
    }

    .form-control[disabled] {
        background: #f7f7f7 !important;
    }

    .modal-dialog {
        padding-top: 12%;
    }

    #btn_Gui {
        background-color: #868686;
        color: #fff;
        padding: 3px 21px;
        margin-top: 2px;
        width: 120px;
        text-align: left;
    }

    .dropdown.bootstrap-select.form-control {
        padding: 0px;
        margin: 0px;
        background: none;
        width: 280px;
        max-width: 287px;
        padding-left: 0px !important;
        border: none !important;
    }

    .bootstrap-select .dropdown-toggle .filter-option-inner-inner {
        color: #59595B;
    }

    .col-sm-8 .btn {
        height: 27px;
        line-height: 13px;
    }

    .box_loaihinh .form-check {
        display: inline-block;
        padding: 3px 3%;
    }

    .box_loaihinh {
        padding-top: 15px;
        padding-bottom: 15px;
    }

        .box_loaihinh label {
            font-size: 14px !important
        }

    input, select, textarea {
        max-width: 288px;
    }

    .btn-info {
        padding: 4px !important;
        text-align: left;
        max-width: 150px;
        border: none;
    }

    #tbl_Item {
        margin-top: 18px;
        font-size: 12px;
    }

    .content_search label {
        font-size: 13px;
        text-align: left !important;
        padding-top: 6px;
    }

    .btn-info:hover {
        color: #fff;
        background-color: #868686;
        border-color: #868686;
    }

    .btn:hover, .btn:focus, .btn.focus {
        color: #fff;
        background-color: #868686;
        border-color: #868686;
    }

    .wp_hearder {
        padding: 5px 0px;
        background-color: #868686;
        position: fixed;
        z-index: 999;
        top: 0;
        height: 65px !important;
        width: 100%;
    }

    .card-body {
        width: 100%;
        text-align: center;
        margin-left: 1%;
        margin-top: 0px;
    }

    .content {
        -webkit-transition: all .4s ease-in-out;
        -moz-transition: all .4s ease-in-out;
        -o-transition: all .4s ease-in-out;
        -ms-transition: all .4s ease-in-out;
    }

    .btn_search {
        background-color: #868686;
        color: #fff;
        width: 100%;
        height: 23px;
        margin-bottom: 4px;
        padding: 2px 19px !important;
        text-align: left;
        font-size: 12px;
    }

    .wp_table {
        padding-top: 134px;
    }

    body {
        font-size: 12px;
    }

    .wp_table {
        width: 90%;
        margin: 0 auto;
    }

    .logo img {
        width: 250px;
    }

    .header_title {
        text-align: center;
        text-transform: uppercase;
        color: #fff;
        font-size: 28px;
        font-weight: bold;
    }

    .header_vender {
        background-color: #868686;
        padding: 18px 0px;
    }

    table.dataTable.no-footer {
        border-bottom: 1px solid #bdbdbd !important;
    }

    .text_home {
        float: right;
        margin-top: 14px;
    }

        .text_home a {
            font-size: 18px;
            color: #fff;
            font-weight: bold;
        }

    .content_search .form-group {
        margin-bottom: 1px !important;
    }

    .content_search .form-control {
        height: 25px !important;
        padding: 0px 0px !important;
    }

    table.dataTable tbody th, table.dataTable tbody td {
        padding: 3px 10px !important;
    }

    #tbl_Item tbody {
        background-color: #ffff;
    }

    .table thead {
        height: 50px !important;
    }

    #tbl_Item th {
        font-size: 12px;
        text-align: left;
        vertical-align: top;
    }

    #tbl_Item thead {
        background-color: #c3c3c3;
    }

        #tbl_Item thead span {
            color: #e45050;
            font-size: 11px;
        }

    .content_table {
        padding-bottom: 72px;
    }

    #tbl_Item_length {
        position: absolute;
        bottom: 0px;
        left: 182px;
    }

    table.dataTable thead th, table.dataTable thead td {
        padding: 1px 5px !important;
        border-bottom: 1px solid #f1f1f1 !important;
        font-size: 11px !important;
    }

    .table > tr > td {
        padding: 1px 5px !important;
        border-bottom: 1px solid #f1f1f1 !important;
        font-size: 11px !important;
    }

    .container_1 {
        width: 100% !important;
        margin: 0 auto !important;
    }

    .rank2 {
        padding-bottom: 5px;
        width: 173px;
        padding-left: 14px;
        padding-right: 6px;
    }

    .container1 {
        width: 1300px;
        margin: auto;
    }

    table {
        width: 100%;
    }

    td {
        border: 1px solid black;
        width: 200px;
    }

    .hack1 {
        display: table;
        table-layout: fixed;
        width: 100%;
    }

    .hack2 {
        display: table-cell;
        overflow-x: auto;
        width: 100%;
    }

    .col {
        width: 10%
    }

    .modal tbody tr td {
        text-align: center
    }
</style>

@Html.Partial("~/Views/Shared/_sidebar_3.cshtml")
<div id="wp_order">
    <div class="header_vender_1">
        @Html.Partial("~/Views/Shared/_header_home.cshtml")
    </div>
    <div class="content_order">
        @Html.Partial("~/Views/PushSale/Partial/Header.cshtml")
        <div id="wp_order" style="padding-top: 165px; ">
            <div class="content_order">
                <div class="container_1  searchfroms">
                    <div class="content_search">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="box_with">
                                    <div class="form-group row">
                                        <label for="MaHang" class="col-sm-4 col-form-label">Hạng mục </label>
                                        <div class="col-sm-8">
                                            <select id="HangMuc" class="form-control selectpicker" data-live-search="true" onchange="js_searchbox()">
                                                @*@if (ViewBag.List_Mahang != null)
                                                    {
                                                        <option value="">--- Chọn mã NCC ---</option>
                                                        foreach (objCombox box in (List<objCombox>)ViewBag.List_Mahang)
                                                        {
                                                            <option value="@box.Code - @box.Name">@box.Code - @box.Name</option>
                                                        }
                                                    }*@
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="box_with">
                                    <div class="form-group row">
                                        <label for="textStatus" class="col-sm-4 col-form-label">Trạng thái</label>
                                        <div class="col-sm-8">
                                            <select class="form-control" id="textStatus" onclick="js_searchbox();">
                                                <option value="">-- Chọn trạng thái --</option>
                                                <option value="0">Mới tạo</option>
                                                <option value="2">Gửi duyệt</option>
                                                <option value="1">Đã duyệt</option>
                                                <option value="3">Từ chối</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-2" style="text-align: right;">
                                <select class="form-control " id="HanhDong" style=" margin-bottom: 3px !important; float: left; text-align: left; max-width: 150px; ">
                                    <option value="">-- Chọn hành động --</option>
                                    @*<option value="1">Thêm mới</option>*@
                                    <option value="2">Gửi duyệt</option>
                                    <option value="4">Hủy bỏ</option>
                                </select>
                                <a onclick="HanhDongsave()" style="text-align: left; max-width: 150px;float:left;" class="btn btn-secondary btn_search"><i class="fa fa-forward" aria-hidden="true" style="margin-top: 3px; margin-right: 3px;"></i> Tiếp </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="content_table">
                        <div class="row_2" style=" padding-top: 60px; ">
                            <div class="card-body" style="width:98%">
                                <div class="table-responsive_2" id="div-content">
                                    @Html.Partial("~/Views/PushSale/Partial/__TangCuongNhanDien.cshtml")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<input id="showTangCuongNhanDien" type="hidden" data-toggle="modal" data-target="#TangCuongNhanDien_modal" />
<div class="modal" id="TangCuongNhanDien_modal" tabindex="-1" role="dialog" aria-labelledby="shift_detail_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width:1000px; border-radius:0; ">
        <div class="modal-content">
            <div class="modal-header" style="background:#c4c4c4; color:#4f4f4f;padding: 7px;">
                <h5 class="modal-title" id="shift_detail_modal_label" style="font-size:18px;display: contents; text-transform:uppercase">THÔNG TIN CHI TIẾT</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="row from_vender frominput">
                <div style=" clear: both; height: 22px"></div>
                <div class="col-md-12">
                    <div class="col-md-6">
                        <div class="col-md-4">
                            <label>Hạng mục</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="HangMuc_TC" name="HangMuc_TC">
                        </div>
                        <div class="col-md-4">
                            <label>Đơn vị</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control " id="DonVi" name="DonVi">
                        </div>
                        <div class="col-md-4">
                            <label>Áp dung từ ngày</label>
                        </div>
                        <div class="col-md-8">
                            <input type="date" class="form-control" id="FromDay" name="FromDay">
                        </div>
                        <div class="col-md-4">
                            <label>Áp dụng đến ngày</label>
                        </div>
                        <div class="col-md-8">
                            <input type="date" class="form-control" id="ToDay" name="ToDay">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="col-md-4">
                            <label>Đơn giá</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control  text-right OrderValue" onchange="js_Sum()" id="DonGia" name="DonGia">
                        </div>

                        <div class="col-md-4">
                            <label>Số lượng</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control  text-right OrderValue" onchange="js_Sum()" id="SoLuong" name="SoLuong">
                        </div>


                        <div class="col-md-4">
                            <label>Thành tiền</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" class="form-control  text-right OrderValue" id="ThanhTien" name="ThanhTien" disabled>
                        </div>
                    </div>
                </div>
                <div style=" clear:both; height:10px"></div>
                <input type="hidden" name="ID" id="ID" value="0" />
                <div style="text-align:right;margin:15px;margin-right: 40px;">
                    <a href="#" onclick="fn_save_TCND_POP()" id="btn_Gui" class="btn btn-secondary Luulai"><i class="far fa-paper-plane"></i> Lưu lại</a>
                    <a href="#" data-dismiss="modal" id="btn_Gui" class="btn btn-secondary"><i class="fas fa-times"></i> Đóng </a>
                </div>
                <div style=" height:30px"></div>
            </div>
        </div>

    </div>
</div>


<script type="text/javascript">
    $(function () {
        $('#txtHead').html("Quản lý chương trình Push Sale NCC");
        $('#f_dev').html("");
        $('#f_header').html("");
        $('#v_review').hide();
        $('#v_view').hide();
        $('#v_approve').hide();

        $("#TangCuongNhanDien").prop("checked", true);
        js_onchange_HangMuc();

        Get_GAP_TangCuongNhanDien();
        js_GetList();
    });
    function js_searchbox_NCC() {
        js_onchange_HangMuc();
        js_GetList();
    }
    function js_searchbox() {

        js_GetList();
    }

    function Get_GAP_TangCuongNhanDien() {
        $("#GAP").val('');
        $('#GAP').selectpicker().empty();
        option = document.createElement('option');
        option.text = '-- Chọn mã GAP --';
        option.value = '';
        $('#GAP').selectpicker().append(option);

        $.ajax({
            url: '/PushSale/sp_Pushsale_GAP_TangCuongNhanDien_get',
            type: 'POST',
            contentType: 'application/json, charset=utf-8',
            success: function (data) {
                $.each(data, (index, value) => {
                    option = document.createElement('option');
                    option.text = value.Code + ' - ' + value.Name;
                    option.value = value.Code + ' - ' + value.Name;
                    $('#GAP').selectpicker().append(option);
                });
                $('#GAP').selectpicker('refresh');
            }
        });
    }

    function js_ReloadTable() {
        $('#tbl_Item').DataTable({
            lengthMenu: [[50, 70, 100, -1], [50, 70, 100]],
            //columnDefs: [
            //    //{ 'targets': 0, 'searchable': false, 'orderable': false },
            //    //{ 'targets': 2, 'searchable': false, 'orderable': false },
            //    //{ 'targets': 3, 'searchable': false, 'orderable': false },
            //    //{ 'targets': 4, 'searchable': false, 'orderable': false },
            //    { 'targets': 5, 'searchable': false, 'orderable': false },
            //    { 'targets': 6, 'searchable': false, 'orderable': false },
            //    { 'targets': 7, 'searchable': false, 'orderable': false }
            //],
            "searching": false,
            autoWidth: false,
            // pageLength: -1,
            "language": {
                "emptyTable": "Không có dữ liệu !"
            },
            fixedHeader: {
                headerOffset: 230
            }
        });
    }


    function js_GetList() {
        var VendorNo = fomart_split($("#VendorNo").val(), 0);

        var HangMuc = fomart_split($("#HangMuc").val(), 1);
        var Status = $("#textStatus option:selected").val();
        var GAP = fomart_split($("#GAP").val(), 0);
        $.ajax({
            url: '/PushSale/Get_List_TangCuongNhanDien',
            type: 'POST',
            data: JSON.stringify({ VendorCode: VendorNo,HangMuc: HangMuc, Status: Status, GAP: GAP }),
            contentType: 'application/json, charset=utf-8',
            beforeSend: function () {
                //js_Loading(true, 1);
                //console.log('gfdfgdf');
            },
            success: function (data) {
                $("#div-content").find('tbody').empty();
                $('#div-content').html(data);
                js_ReloadTable();
                //js_Loading(false, 1);
            },
            error: function () {
                //js_Loading(false, 1);
            }
        });
    }

    function HanhDongsave() {
        debugger;
        var IDPusSale = [];
        var HanhDong = $("#HanhDong").val();
        $("#CheckID input:checked").each(function (index, value) {
            IDPusSale.push($(value).val());
        });
        if (IDPusSale == "") {
            alert("Bạn chưa chọn hành động");
            return;
        }
        if (HanhDong == "") {
            alert("Bạn chưa chọn trạng thái");
            return;
        }
        console.log(JSON.stringify({ IDPusSale }));
        if (HanhDong == "4") {
            jConfirm('Bạn chắc chắn muốn xóa ?', '', function (r) {
                if (r) {
                    $.ajax({
                        type: "POST",
                        url: '/PushSale/Delete_TangCuongNhanDien',
                        data: JSON.stringify({ IDPusSale: IDPusSale }),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (rt) {
                            if (rt.code == 0) {
                                js_GetList();
                            }
                        }
                    });
                }
            });
        }
        else if (HanhDong == "2") {
            $.ajax({
                type: "POST",
                url: '/PushSale/Update_Status_TangCuongNhanDien',
                data: JSON.stringify({ IDPusSale: IDPusSale, HanhDong: HanhDong }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (rt) {
                    if (rt.code == 0) {
                        js_GetList();
                    }
                }
            });
        }
    }
</script>

<script>
    // PopUp, Uodate
    function load_TCND_POP(ID) {
        $.ajax({
            type: "POST",
            url: "/PushSale/Listget_TangCuongNhanDien_PopUp",
            data: JSON.stringify({ ID: ID }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend: function () {
                // js_Loading(true, 1);
            },
            success: function (data) {
                if (data != null) {
                    $('#HangMuc_TC').val(data.HangMuc);
                    $('#DonVi').val(data.DonVi);
                    $('#DonGia').val(data.DonGia);
                    $('#SoLuong').val(data.SoLuong);
                    $('#ToDay').val(data.ToDay);
                    $('#FromDay').val(data.FromDay);
                    $('#ThanhTien').val(data.ThanhTien);
                    $('#ID').val(data.ID);

                    // Kiểm tra nếu đã duyệt thì ko cho sửa disabled
                    if (data.Status == "1" || data.Status == "2" || data.Status == "3") {
                        // $("#GiaTruocThayDoi").prop("disabled", true);
                        $("#HangMuc").prop("disabled", true);
                        $("#DonVi").prop("disabled", true);
                        $("#DonGia").prop("disabled", true);
                        $("#SoLuong").prop("disabled", true);
                        $("#ToDay").prop("disabled", true);
                        $("#FromDay").prop("disabled", true);
                        $(".Luulai").hide();
                    } else {
                        $("#HangMuc").prop("disabled", false);
                        $("#DonVi").prop("disabled", false);
                        $("#DonGia").prop("disabled", false);
                        $("#SoLuong").prop("disabled", false);
                        $("#ToDay").prop("disabled", false);
                        $("#FromDay").prop("disabled", false);
                        $(".Luulai").show();
                    }
                    document.getElementById("showTangCuongNhanDien").click();
                }
                // js_Loading(false, 1);
            }, error: function () {
                // js_Loading(false, 1);
            }
        });
        // await sleep(1000);
        // reload();
    }

    function fn_save_TCND_POP() {
        if (
            $('#HangMuc_TC').val().length == 0 ||
            $('#DonVi').val().length == 0 ||
            $('#DonGia').val().length == 0 ||
            $('#SoLuong').val().length == 0 ||
            $('#ToDay').val().length == 0 ||
            $('#FromDay').val().length == 0 ||
            $('#ThanhTien').val().length == 0
        ) {
            alert('Vui lòng nhập các trường đầy đủ.');
            return;
        }
        var ID = $('#ID').val();
        var prd = {};
        prd.ID = ID;
        prd.HangMuc = $('#HangMuc_TC').val();
        prd.DonVi = $('#DonVi').val();
        prd.DonGia = $('#DonGia').val().replaceAll(",", "");
        prd.SoLuong = $('#SoLuong').val().replaceAll(",", "");
        prd.ToDay = $('#ToDay').val();
        prd.FromDay = $('#FromDay').val();
        prd.ThanhTien = $('#ThanhTien').val().replaceAll(",", "");

        console.log(JSON.stringify({ prd }));
        console.log(prd);

        $.ajax({
            url: '/PushSale/Update_TangCuongNhanDien',
            type: 'POST',
            data: JSON.stringify({ info: prd }),
            contentType: 'application/json, charset=utf-8',
            beforeSend: function () {
                //  js_Loading(true, 1);
            },
            success: function (data) {
                if (data) {
                    jAlert('Cập nhật thành công', 'Thông báo', (r) => {
                        location.reload();
                    });
                } else {
                    jAlert('Có lỗi xảy ra', 'Thông báo');
                }
                js_Loading(false, 1);
            },
            error: function () {
                js_Loading(false, 1);
            }
        });
    }

    function js_onchange_HangMuc() {
        debugger;
        $('#HangMuc').empty();
        $('#HangMuc').selectpicker('refresh');

        let NCC = $('#VendorNo').val();
        var ArrNCC = NCC.split(" - ");
        if (NCC.length > 0) {
            // Call MaHang
            $.ajax({
                url: '/PushSale/Get_List_TangCuongNhanDien_HangMuc',
                type: 'POST',
                data: JSON.stringify({ NCC: ArrNCC[0] }),
                contentType: 'application/json, charset=utf-8',
                success: function (data) {
                    var row = JSON.parse(data);
                    if (row != null) {
                        $('#HangMuc').empty();
                        $('#HangMuc').append('<option value="">--Chọn hạng mục --</option>');
                        for (i in row) {
                            $('#HangMuc').append('<option value="' + row[i].Code + ' - ' + row[i].Name + '">' + row[i].Code + ' - ' + row[i].Name + '</option>');
                        }
                    }
                    $('#HangMuc').selectpicker('refresh');
                }
            });
        }
    }



    function js_Sum() {
        debugger;
        let DonGia = $('#DonGia').val().trim().replaceAll(",", "").replaceAll(".", "");
        let SoLuong = $('#SoLuong').val().trim().replaceAll(",", "").replaceAll(".", "");
        if (DonGia <= 0) {
            DonGia = 0;
        }
        if (SoLuong <= 0) {
            SoLuong = 0;
        }
        var price = parseInt(DonGia) * parseInt(SoLuong);
        $('#ThanhTien').val(commaSeparateNumber(price).replaceAll(".", ","));
    }
    function commaSeparateNumber(val) {
        while (/(\d+)(\d{3})/.test(val.toString())) {
            val = val.toString().replace(/(\d+)(\d{3})/, '$1' + '.' + '$2');
        }
        return val;
    }
</script>