@using System.Data;
@using MP_VendorTool.Common;
<style>
    /*   #tbl_Item .form-control {
        width: auto !important;
    }*/

    #tbl_Item ::-webkit-calendar-picker-indicator {
        margin-left: -15px;
    }

    .table td, .table th {
        padding: 7px;
    }

    input#SoLo {
        text-align: center;
        margin: 0px;
        padding: 7px !important;
        width: 40px;
        background: #fff;
        border: 1px solid rgba(0,0,0,.15);
    }

    .SlXacNhan {
        text-align: center;
        margin: 0px;
        padding: 7px !important;
        width: 40px;
        background: #fff;
        border: 1px solid rgba(0,0,0,.15);
    }
</style>
<div class="table-responsive">

    <table id="tbl_Item" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
        <thead>

            <tr>
                <th class="text-center">
                    Mã SP
                </th>
                <th class="text-center">
                    Tên sản phẩm
                </th>
                <th class="text-center" style="vertical-align: inherit;">
                    Mã kho
                </th>
                <th class="text-center" style="vertical-align: inherit;">
                    Đơn giá <br />(-VAT)
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    % Line Discount
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    VAT %
                </th>
                <th class="text-center" style="vertical-align: inherit;">
                    Đơn giá  <br />(+VAT)
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    Số lượng đặt
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    Tổng tiền <br />(-VAT)
                </th>

                <th class="text-center" style="vertical-align: inherit; ">
                    Tổng tiền <br />(+VAT)
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    SL Xác <br />nhận giao
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    SL  <br />đã giao
                </th>

                <th class="text-center" style="vertical-align: inherit;">
                    Số lô
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    Ngày<br />sản xuất
                    <div style="text-align: center; margin-left:0px;">
                        <input type="date" name="HNgaySanXuat" id="HNgaySanXuat" class="form-control" style="height: 27px " />
                    </div>
                </th>
                <th class="text-center" style="vertical-align: inherit; ">
                    Ngày <br />hết hạn
                    <div style="text-align: center; margin-left:0px;">
                        <input type="date" name="HNgayHetHan" id="HNgayHetHan" class="form-control" style="height: 27px " />
                    </div>
                </th>

                <th class="text-center " style="vertical-align: inherit; ">
                    Ngày có thể giao
                    <div style="text-align: center; margin-left:0px;">
                        <input type="date" name="f_DeliveryDate" id="f_DeliveryDate" class="form-control Dateinput" min="@DateTime.Today.ToString("yyyy-MM-dd")" style="height: 27px " />
                    </div>
                </th>
                <th class="text-center" style="vertical-align: inherit;">
                    Thời gian giao
                    <div style="text-align: center; margin-left: 5px;">
                        <input type="time" id="changeReceiptTime" name="ExpectedReceiptTime" class="form-control" style="width: auto !important; height: 25px !important; " />
                    </div>
                </th>
                <th class="text-center" style="vertical-align: inherit;">
                    YC giao ngày
                </th>
                <th class="text-center" style="vertical-align: inherit; width: 130px; ">
                    Ghi chú
                </th>
            </tr>
        </thead>

        <tbody>
            @{

                if (Model != null)
                {
                    var dt = Model as DataTable;
                    if (dt.Rows.Count > 0)
                    {
                        int i = 1;
                        foreach (DataRow item in dt.Rows)
                        {
                            <tr id="@item["Line No_"]" class="Row_@i">
                                <td class="text-center" style="vertical-align: inherit;">
                                    @item["Item No_"]
                                    <input type="hidden" name="ItemNo" value="@item["Item No_"]" />
                                    <input type="hidden" name="LineNo" value="@item["Line No_"]" />
                                </td>
                                <td class="text-left" style="width: 200px; max-width: 200px; " title="@item["ItemName"]">
                                    @item["ItemName"]
                                </td>
                                <td class="text-left">
                                    @item["LocationCode"]
                                </td>
                                <td class="text-right">
                                    @*@item["DirectUnitCost"]*@
                                    <span id="DirectUnitCostNo_@i" style=" display:none"> @item["DirectUnitCostNo"]</span>
                                    @item["DirectUnitCostTruVAT"]
                                </td>
                                <td class="text-right">
                                    @item["lineDiscout"]
                                </td>
                                <td class="text-right">
                                    @item["VATS"]
                                </td>
                                <td class="text-right">
                                    @item["DirectUnitCostCongVAT"]
                                    <span id="DirectUnitCostCongVAT_@i" style=" display:none"> @item["DirectUnitCostCongVAT_Fomart"]</span>
                                </td>

                                <td class="text-right">
                                    @item["Quantity"]
                                </td>
                                <td class="text-right" style="">
                                    @if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                    {
                                        @item["TongTienTruVAT_Active"]
                                    }
                                    else
                                    {
                                        @item["TongTienTruVAT_Active"]
                                        <span id="TongTienTruVAT_No_Active_@i" class="TongTienTruVAT_No_Active" style=" display:none">@item["TongTienTruVAT_Active"].ToString().Replace(",", "")</span>
                                    }
                                </td>

                                <td class="text-right">
                                    @if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                    {
                                        @item["TongTienCongVAT_Active"]
                                    }
                                    else
                                    {
                                        @item["TongTienCongVAT_Active"]
                                        <span id="TongTienCongVAT_No_Active_@i" class="TongTienCongVAT_No_Active" style=" display:none">@item["TongTienCongVAT_Active"].ToString().Replace(",", "")</span>
                                    }
                                </td>

                                <td class="text-center" style="width: 80px; max-width: 80px; ">
                                    @*<input type="number" @(item["Status"].ToString() == "1" ? "disable" : "") name="QtyToReceive" class="form-control" value="@item["Qty_ to Receive"]" />*@
                                    @if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                    {
                                        <input type="number" disabled name="QtyToReceive" class="form-control SlXacNhan" style="width: 80px !important" value="@item["Qty_ to Receive"]" />
                                    }
                                    else
                                    {
                                        if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                        {
                                            if (item["DeliveryDate"].ToString().Length == 1)
                                            {
                                                <input type="number" @(item["Status"].ToString() == "1" ? "disable" : "") name="QtyToReceive " style="width: 80px !important" class="form-control SlXacNhan" value="@item["Qty_ to Receive"]" />
                                            }
                                            else
                                            {
                                                if (Convert.ToInt32(item["TrangThai"].ToString()) > 0)
                                                {
                                                    <input type="number" @(item["Status"].ToString() == "1" ? "disable" : "") name="QtyToReceive" style="width: 80px !important" class="form-control SlXacNhan" value="@item["Qty_ to Receive"]" />
                                                }
                                                else
                                                {
                                                    <input type="number" @(item["Status"].ToString() == "1" ? "disable" : "") onchange="GetTotalSLGiao(@i)" style="width: 80px !important" name="QtyToReceive" class="form-control SlXacNhan" value="@item["Quantity"]" />
                                                }
                                            }
                                        }
                                        else
                                        {
                                            <input type="number" disabled name="QtyToReceive" class="form-control" style="width: 80px !important" value="@item["Qty_ to Receive"]" />
                                        }
                                    }

                                </td>
                                <td class="text-right">
                                    @item["TongSLDaGiaoHang"]
                                </td>
                                <td class="text-right" style="width: 80px; max-width: 80px; ">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                        {
                                            <input type="text" disabled style="background: #e9ecef; width: 80px !important " class="form-control" name="SoLo" id="SoLo" value="@item["SoLo"]" />
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" name="SoLo" id="SoLo" style="width: 80px  !important" value="@item["SoLo"]" />
                                        }
                                    }
                                    else
                                    {
                                        <input type="text" disabled style="background: #e9ecef; width: 80px !important " class="form-control" name="SoLo" id="SoLo" value="@item["SoLo"]" />
                                    }
                                </td>
                                <td class="text-right">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                        {
                                            <input type="date" disabled class="form-control NgaySanXuat" name="NgaySanXuat" id="NgaySanXuat" value="@item["NgaySanXuat"]" />
                                        }
                                        else
                                        {
                                            <input type="date" class="form-control NgaySanXuat" name="NgaySanXuat" id="NgaySanXuat" value="@item["NgaySanXuat"]" />
                                        }
                                    }
                                    else
                                    {
                                        <input type="date" disabled class="form-control NgaySanXuat" name="NgaySanXuat" id="NgaySanXuat" value="@item["NgaySanXuat"]" />
                                    }
                                </td>
                                <td class="text-right">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                        {
                                            <input type="date" disabled class="form-control NgayHetHan" name="NgayHetHan" id="NgayHetHan" value="@item["NgayHetHan"]" />
                                        }
                                        else
                                        {
                                            <input type="date" class="form-control NgayHetHan" name="NgayHetHan" id="NgayHetHan" value="@item["NgayHetHan"]" />
                                        }
                                    }
                                    else
                                    {
                                        <input type="date" disabled class="form-control NgayHetHan" name="NgayHetHan" id="NgayHetHan" value="@item["NgayHetHan"]" />
                                    }
                                </td>
                                <td class="text-center">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                        {
                                            <input type="date" disabled name="DeliveryDate" class="form-control " min="@DateTime.Today.ToString("yyyy-MM-dd")" value="@item["DeliveryDate"]" />
                                        }
                                        else
                                        {
                                            <input type="date" name="DeliveryDate" class="form-control DeliveryDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" value="@item["DeliveryDate"]" />
                                        }
                                    }
                                    else
                                    {
                                        <input type="date" disabled name="DeliveryDate" class="form-control DeliveryDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" value="@item["DeliveryDate"]" />
                                    }
                                </td>
                                <td class="text-center time">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        if (Convert.ToInt32(item["Status"].ToString()) == 1)
                                        {
                                            if (item["TimeERDate"].ToString() == "00:00")
                                            {
                                                <input type="time" disabled name="ExpectedReceiptTime" style="width: 120px !important" class="form-control" value="04:20 A" />
                                            }
                                            else
                                            {
                                                <input type="time" disabled name="ExpectedReceiptTime" style="width: 120px !important" class="form-control" value="@item["TimeERDate"]" />
                                            }
                                        }
                                        else
                                        {
                                            if (item["TimeERDate"].ToString() == "00:00")
                                            {
                                                <input type="time" name="ExpectedReceiptTime" style="width: 120px !important" class="form-control ExpectedReceiptTime" value="04:20 A" />
                                            }
                                            else
                                            {
                                                <input type="time" name="ExpectedReceiptTime" style="width: 120px !important" class="form-control ExpectedReceiptTime" value="@item["TimeERDate"]" />
                                            }
                                        }

                                    }
                                    else
                                    {
                                        if (item["TimeERDate"].ToString() == "00:00")
                                        {
                                            <input type="time" disabled name="ExpectedReceiptTime" style="width: 120px !important " class="form-control" value="04:20 A" />
                                        }
                                        else
                                        {
                                            <input type="time" disabled name="ExpectedReceiptTime" style="width: 120px !important " bclass="form-control" value="@item["TimeERDate"]" />
                                        }
                                    }
                                </td>
                                <td class="text-center">
                                    <input type="hidden" name="EReceiptDate" value="@item["Expected Receipt Date"]" />
                                    @item["Expected Receipt Date"]
                                </td>
                                <td class="text-center">
                                    @if (Convert.ToInt32(item["Disabled"].ToString()) == 1)
                                    {
                                        <textarea type="text" name="Note" id="Note" style="width: 120px !important" class="form-control">@item["Note"]</textarea>
                                    }
                                    else
                                    {
                                        <textarea type="text" disabled id="Note" style="width: 120px !important" name="Note" class="form-control">@item["Note"]</textarea>
                                    }
                                </td>
                            </tr>
                            i++;
                        }
                    }
                }
            }
        </tbody>
        <tfoot>
            @{
                if (Model != null)
                {
                    var dt = Model as DataTable;
                    if (dt.Rows.Count > 0)
                    {
                        if (Convert.ToInt32(dt.Rows[0]["TrangThai"].ToString()) == 0)
                        {
                            <script>
                                $(function () {
                                    GetTotalSLGiao(0);
                                });
                            </script>
                        }
                        <tr style="background: #ffffff; border-bottom: 1px solid #ddd !important; border-top: 1px solid #fff; border-left: 1px solid #fff; border-right: 1px solid #fff !important;">
                            <td class="text-left" style="border: none !important;"></td>
                            <td class="text-left" style="border: none !important;"></td>
                            <td class="text-left" style="border: none !important;"></td>
                            <td class="text-left" style="border: none !important;"></td>
                            @*<td class="text-right" style="border: none !important;">@ViewBag.TotalDirectUnitCost</td>*@
                            <td class="text-right" style="border: none !important;">@*@ViewBag.TotalDirectUnitCostTruVAT*@</td>
                            <td class="text-right" style="border: none !important;">
                            </td>
                            <td class="text-right" style="border: none !important;">@*@ViewBag.TotalDirectUnitCostCongVAT*@</td>

                            <td class="text-right" style="border: none !important; width: 90px;">@ViewBag.TotalQuantity</td>
                            <td class="text-right" style="border: none !important;">
                                @*@if (Convert.ToInt32(dt.Rows[0]["TrangThai"].ToString()) > 0)
                                    {
                                        @ViewBag.TotalTongTienTruVAT_Active
                                    }
                                    else
                                    {
                                        <div id="TotalTongTienTruVAT"> @ViewBag.TotalTongTienTruVAT_No_Active</div>
                                    }*@
                                @ViewBag.TotalTongTienTruVAT_Active
                            </td>
                            <td class="text-right" style="border: none !important;">
                                @*@if (Convert.ToInt32(dt.Rows[0]["TrangThai"].ToString()) > 0)
                                    {
                                        @ViewBag.TotalTongTienCongVAT_Active
                                    }
                                    else
                                    {
                                        <div id="TotalTongTienCongVAT"> @ViewBag.TotalTongTienCongVAT_No_Active</div>
                                    }*@
                                @ViewBag.TotalTongTienCongVAT_Active
                            </td>
                            <td class="text-right" style="border: none !important;">
                                <div id="TotalSLGiao">@dt.Rows[0]["TotalSLGiao"] </div>
                            </td>
                            <td class="text-right" style="border: none !important; width: 90px;">@ViewBag.TotalTongSLDaGiaoHang</td>
                            <td class="text-right" style="border: none !important;">
                            </td>
                            <td class="text-right" style="border: none !important;">
                            </td>
                            <td class="text-right" style="border: none !important;">
                            </td>
                            <td class="text-right" style="border: none !important;">
                            </td>
                        </tr>
                    }
                }
            }
        </tfoot>
    </table>

</div>
<script type="text/javascript">
    $('#changeReceiptTime').on('change', function () {
        var date = $('#changeReceiptTime').val().split(':');
        var hours = parseInt(date[0]);
        var minutes = parseInt(date[1]);
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0 should be 12
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes; // if minutes less than 10,    add a 0 in front of it ie: 6:6 -> 6:06
        var strTime = hours + ':' + minutes + ' ' + ampm;
        var strTime2 = hours + ':' + minutes;

        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                $('#' + tr.id + '  .ExpectedReceiptTime').val(strTime2);
            });
        }

    });

    $('#f_DeliveryDate').on('change', function () {

        var DeliveryDate = $('#f_DeliveryDate').val();
        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                $('#' + tr.id + ' .DeliveryDate').val(DeliveryDate);
            });
        }
    });

    $('#HNgaySanXuat').on('change', function () {

        var DeliveryDate = $('#HNgaySanXuat').val();
        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                $('#' + tr.id + ' .NgaySanXuat').val(DeliveryDate);
            });
        }
    });

    $('#HNgayHetHan').on('change', function () {

        var DeliveryDate = $('#HNgayHetHan').val();
        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                $('#' + tr.id + ' .NgayHetHan').val(DeliveryDate);
            });
        }
    });


    function GetTotalSLGiao(r) {

        var Sum = 0;
        var SumTotalTongTienTruVAT = 0;
        var SumTotalTongTienCongVAT = 0;
        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                let QtyToReceive = String($('#' + tr.id + ' input[name="QtyToReceive"]').val()).trim();
                let DirectUnitCost = $('#' + tr.id + ' #DirectUnitCostNo_' + r + '').html();
                let DirectUnitCostCongVAT = $('#' + tr.id + ' #DirectUnitCostCongVAT_' + r + '').html();

                if (QtyToReceive.length > 0) {
                    Sum += parseInt(QtyToReceive);
                }

                // - VAT
                //SL giao * Đơn giá (-VAT) --> đã Xác nhận đơn hàng
                var SumPriceTruVat = parseInt(QtyToReceive) * parseInt(DirectUnitCost);
                $('#' + tr.id + ' #TongTienTruVAT_No_Active_' + r + '').html(commaSeparateNumber(SumPriceTruVat));

                // +VAT
                //Tổng tiền(+VAT) = SL giao * Đơn giá(+VAT)-- > đã Xác nhận đơn hàng
                var SumPriceCongVat = parseInt(QtyToReceive) * parseInt(DirectUnitCostCongVAT);
                $('#' + tr.id + ' #TongTienCongVAT_No_Active_' + r + '').html(commaSeparateNumber(SumPriceCongVat));

            });
        }
        $('#TotalSLGiao').html(commaSeparateNumber(Sum));
        SumTotal();
    }

    function SumTotal() {

        var SumTotalTongTienTruVAT = 0;
        var SumTotalTongTienCongVAT = 0;
        let trs = $("#tbl_Item tbody tr");
        if (trs.length) {
            trs.each((index, tr) => {
                let TongTienTruVAT_No_Active = $('#' + tr.id + ' .TongTienTruVAT_No_Active').html();
                if (TongTienTruVAT_No_Active.length > 0) {
                    SumTotalTongTienTruVAT += parseInt(replaceAll(TongTienTruVAT_No_Active));
                }

                let TongTienCongVAT_No_Active = $('#' + tr.id + ' .TongTienCongVAT_No_Active').html();
                if (TongTienCongVAT_No_Active.length > 0) {
                    SumTotalTongTienCongVAT += parseInt(replaceAll(TongTienCongVAT_No_Active));
                }
            });
        }
        $('#TotalTongTienTruVAT').html(commaSeparateNumber(SumTotalTongTienTruVAT));
        $('#TotalTongTienCongVAT').html(commaSeparateNumber(SumTotalTongTienCongVAT));
    }

    function replaceAll(val) {
        if (val != '' || val != 'undefined') {
            try {
                return val.replaceAll(",", "").replaceAll(".", "")
            } catch (e) {

            }
        }
        return val;
    }

    function commaSeparateNumber(val) {
        while (/(\d+)(\d{3})/.test(val.toString())) {
            val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
        }
        return val;
    }
    jQuery(document).bind("keyup keydown", function (e) {
        if (e.ctrlKey && e.keyCode == 80) {
            return false;
        }
    });
</script>
