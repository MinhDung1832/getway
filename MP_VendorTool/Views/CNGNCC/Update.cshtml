@using MP_VendorTool.Models.Order;
@{
    ViewBag.Title = "CẬP NHẬT GIÁ MUA TỪ NHÀ CUNG CẤP";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    body.fixed-layout .content-wrapper, body.fixed-navbar .content-wrapper {
        padding-top: 0px;
    }

    .wrapper {
        width: 97%;
    }

    input, select, textarea {
        max-width: 100%;
    }

    #btn_Gui {
        background-color: #868e96;
        color: #fff;
        padding: 3px 21px;
        margin-top: 2px;
        width: 170px;
        height: 30px;
        border-radius: 3px;
        text-align: center;
    }

    #btn_Guigm {
        background-color: #868e96;
        color: #fff;
        padding: 3px 21px;
        margin-top: 2px;
        width: 170px;
        height: 30px;
        border-radius: 3px;
        text-align: center;
    }

    .from_vender input, .from_vender select {
        margin-bottom: 3px !important;
    }

    .content_vendor {
    }

    .logo img {
        width: 250px;
    }

    .btn-success {
        color: #fff;
        background-color: #cccccc;
        border: none;
    }

        .btn-success:hover, .btn-success:active, .btn-success:focus, .btn-success:active:focus, .btn-success:active:hover {
            color: #fff;
            background-color: #cccccc;
            border: none;
        }

    .header_title {
        text-align: center;
        text-transform: uppercase;
        color: #fff;
        font-size: 22px;
        font-weight: bold;
    }

    .img_src {
        padding: 10px 10px 43px;
    }

    .thum_img {
        height: 355px;
    }

    .header_vender {
        background-color: #868686;
        padding: 18px 0px;
    }

    .text_home {
        float: right;
        margin-top: 18px;
    }

        .text_home a {
            font-size: 18px;
            color: #fff;
            font-weight: bold;
        }

    fieldset h4 {
        display: block;
        width: 100%;
        padding: 0;
        margin-bottom: 10px;
        margin-top: 10px;
        font-size: 22px;
        line-height: inherit;
        color: #355c96;
        text-transform: uppercase;
        border: 0;
        padding-left: 10px;
    }

    fieldset {
        margin-top: 34px;
    }

    label {
        font-size: 12px;
        color: #777575;
    }

    .from_vender {
        margin-left: 8px;
    }

    .button_save_1 {
        margin-right: 16px;
        margin-top: 20px;
        width: 331px;
    }

        .button_save_1 a {
            text-align: center;
            background-color: #868686 !important;
            border-color: #868686 !important;
            font-size: 12px;
            font-weight: bold;
            padding-top: 8px;
        }

    .content-wrapper {
        padding-top: 47px;
    }

    hr {
        margin-top: 20px;
        margin-bottom: 20px;
        border: 0;
        border-top: 1px solid #868686;
        width: 90%;
    }

    .button_save_1 a:hover {
        text-decoration: none;
    }

    .btn-primary {
        background-color: #86868600;
        border-color: #868686;
        color: #6f8cb8 !important;
    }

    .button_action a:hover {
        background-color: #008888;
        color: #fff !important;
    }

    .button_action a {
        text-align: center;
        font-size: 12px;
        height: 42px;
        padding: 12px 12px;
        font-weight: bold;
    }

    .button_action {
        margin-top: 44px;
    }

    .table > thead > tr > th {
        color: #6f8cb8;
    }

    #wp_thum_img {
        background-color: #fff;
        text-align: center;
    }

    /*  .frominput .form-control {
        height: 25px !important;
        width: 428px !important;
        max-width: 428px !important;
    }*/

    .dropdown.bootstrap-select.form-control {
        padding: 0px;
        margin: 0px;
        background: none;
        width: 100%;
        max-width: 100%;
        padding-left: 0px !important;
        border: none !important;
    }

    .col-sm-8 .btn {
        height: 26px;
        line-height: 11px
    }

    .dropdown.bootstrap-select.form-control.bs3 {
        padding-bottom: 1px;
    }

    .bootstrap-select .dropdown-toggle .filter-option-inner-inner {
        overflow: hidden;
        height: 17px;
        padding: 0px;
        font-size: 12px;
        color: #59595B;
        margin-left: 8px;
    }

    .col-sm-9 .btn {
        height: 27px;
        line-height: 13px;
    }

    .Viewtab {
        width: 100%;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-top-right-radius: 14px;
    }

        .tab button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 7px 0px;
            transition: 0.3s;
            font-size: 13px;
            border-top-right-radius: 14px;
            width: 19%;
        }

            .tab button:hover {
                background-color: #ddd;
            }

            .tab button.active {
                background-color: #5f7e98;
                color: #ffffff;
                font-weight: 500;
            }
</style>
<div style=" clear:both; height:10px"></div>
<div class="Viewtab">
    <div class="col-md-12 tab">
        <button class="tablinks active" onclick="window.location = '/CNGNCC/Update'">Cập nhật giá mua </button>
        <button class="tablinks " onclick="window.location = '/CNGNCC/QuanLy'">Quản lý thay đổi giá mua</button>
        <button class="tablinks " onclick="window.location = '/CNGNCC/Duyet'">Duyệt thay đổi giá mua</button>
    </div>
</div>
<div class="wrapper">
    <div class="col-md-12" style="padding-left:0px;padding-right:0px">
        <div class="row from_vender frominput">
            <fieldset>
                <div class="col-md-12">
                    <h4>THÔNG TIN CƠ BẢN</h4>
                </div>
                <div class="col-md-6">
                    <div class="col-md-12">
                        <div class="col-md-4">
                            <label>Nhà cung cấp</label>
                        </div>
                        <div class="col-md-8" ondblclick="$('#NCC').val('').trigger('change'); loadSP();">
                            <select id="NCC" class="form-control selectpicker" data-live-search="true" onchange="loadSP()">
                                @if (ViewBag.lst_NCC != null)
                                {
                                    <option value="">--- Chọn NCC ---</option>
                                    foreach (objCombox box in (List<objCombox>)ViewBag.lst_NCC)
                                    {
                                        <option value="@box.Code">@box.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-12" style="margin-top: 10px;">
                        <div class="col-md-4">
                            <label>Mã hàng <span style=" color:red">*</span></label>
                        </div>
                        <div class="col-md-8">
                            <select id="TenHang" class="form-control selectpicker" data-live-search="true" onchange="js_GetSP();">
                                <option value="">--- Chọn mã hàng ---</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <div class="col-md-12">
                    <h4>Thông tin chi tiết</h4>
                </div>
                <div class="col-md-4">
                    <div class="col-md-6">
                        <label>Giá cũ (- VAT) </label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="GiaTruocThayDoi" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Giá điều chỉnh (- VAT) <span style=" color:red">(*)</span></label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="GiaSauThayDoi" onchange="js_changeGiaCuVAT()">
                    </div>
                    <div class="col-md-6">
                        <label>Giá bán niêm yết khuyến nghị </label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="GiaBanNYKhuyenNghi">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="col-md-6">
                        <label>Giá cũ (+ VAT)</label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="GiaTruocThayDoiPlus" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Giá điều chỉnh (+ VAT) <span style=" color:red">(*)</span></label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="GiaSauThayDoiPlus" onchange="js_changeGiaCu()">
                    </div>
                    <div class="col-md-6">
                        <label>% VAT</label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control valueNumber" type="text" id="VAT_">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="col-md-6">
                        <label>Ngày thông báo chính thức<span style=" color:red">(*)</span></label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control" onchange="" id="NgayThongBaoChinhThuc" type="date">
                    </div>
                    <div class="col-md-6">
                        <label>Ngày hiệu lực</label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control" id="ToDay" type="date">
                    </div>
                    <div class="col-md-6">
                        <label>Ngày kết thúc</label>
                    </div>
                    <div class="col-md-6">
                        <input class="form-control" id="FromDay" type="date">
                    </div>
                </div>
            </fieldset>
            <hr>
        </div>
        <div>
            <div style=" padding-top: 32px;float:right">
                <a href="#" onclick="js_GuiDuyet()" id="btn_Gui" class="btn btn-secondary"><i class="fa fa-paper-plane"></i> Gửi duyệt</a>
            </div>
        </div>

    </div>
</div>
<script>
    $(function () {
    });
    async function loadSP() {
        var NCC = $('#NCC').val();
        $('#TenHang').val('');
        $('#TenHang').selectpicker().empty();
        option = document.createElement('option');
        option.text = '--- Chọn tên hàng ---';
        option.value = '';
        $('#TenHang').selectpicker().append(option);

        await $.ajax({
            type: "POST",
            url: "/CNGNCC/getTenHang",
            data: JSON.stringify({ fillter: 'tenhang', NCC: NCC }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend: function () {

            },
            success: function (r) {
                if (r != null) {
                    for (i in r) {
                        option = document.createElement('option');
                        option.text = r[i].Name;
                        option.value = r[i].Code;
                        $('#TenHang').selectpicker().append(option);
                    }
                    $('#TenHang').selectpicker('refresh');
                }

            }, error: function () {

            }
        });

    }
    function js_GetSP() {
        window.scrollTo(0, 0);
        var TenHang = $('#TenHang').val();
        $.ajax({
            url: '/CNGNCC/getSP',
            type: 'POST',
            data: JSON.stringify({ MaHang: TenHang }),
            contentType: 'application/json, charset=utf-8',
            beforeSend: function () {
                js_Loading(true, 1);
            },
            success: function (data) {
                console.log(data);
                if (data != null) {
                    $('#GiaTruocThayDoi').val(commaSeparateNumber(data.GiaCu));
                    $('#GiaTruocThayDoiPlus').val(commaSeparateNumber(data.GiaCuVAT));
                    $('#VAT_').val(data.VAT);
                }
                js_Loading(false, 1);
            },
            error: function () {
                js_Loading(false, 1);
            }
        });
    }
    function js_changeGiaCuVAT() {

        var GiaSauThayDoi = $('#GiaSauThayDoi').val().replaceAll(",", "").replaceAll(".", "");
        var VAT = $('#VAT_').val();

        if (GiaSauThayDoi > 0 && VAT > 0) {
            var GiaSauThayDoiPlus = parseInt(GiaSauThayDoi) * ((parseInt(VAT) / 100) + 1);
            $('#GiaSauThayDoiPlus').val(commaSeparateNumber(GiaSauThayDoiPlus.toFixed()));
            $('#GiaSauThayDoi').val(commaSeparateNumber(GiaSauThayDoi));
            console.log(GiaSauThayDoi);
            console.log(VAT);
        }
    }

    function js_changeGiaCu() {

        var GiaSauThayDoiPlus = $('#GiaSauThayDoiPlus').val().replaceAll(",", "").replaceAll(".", "");
        var VAT = $('#VAT_').val();

        if (GiaSauThayDoiPlus > 0 && VAT > 0) {
            var GiaSauThayDoi = parseInt(GiaSauThayDoiPlus) / ((parseInt(VAT) / 100) + 1);
            $('#GiaSauThayDoi').val(commaSeparateNumber(GiaSauThayDoi.toFixed()));
            $('#GiaSauThayDoiPlus').val(commaSeparateNumber(GiaSauThayDoiPlus));
        }
    }
    function commaSeparateNumber(val) {
        while (/(\d+)(\d{3})/.test(val.toString())) {
            val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
        }
        return val;
    }
    function js_GuiDuyet() {
        var lst = {};
        lst.MaHang = $('#TenHang').val();
        lst.TenHang = $('#TenHang option:selected').text();
        lst.MaNCC = $('#NCC').val();
        lst.NCC = $('#NCC option:selected').text();
        lst.GiaMoi = $('#GiaSauThayDoi').val();
        lst.GiaMoiVAT = $('#GiaSauThayDoiPlus').val();
        lst.VAT = $('#VAT_').val();
        lst.GiaNY = $('#GiaBanNYKhuyenNghi').val();
        lst.NgayBD = $('#ToDay').val();
        lst.NgayKT = $('#FromDay').val();
        var arr = [];
        arr.push(lst);
        $.ajax({
            url: '/CNGNCC/AddSPDuyet',
            type: 'POST',
            data: JSON.stringify({ lst: arr }),
            contentType: 'application/json, charset=utf-8',
            beforeSend: function () {
                js_Loading(true, 1);
            },
            success: function (data) {
                if (data == 1) {
                    jAlert('Thành công.', 'Thông báo');
                    js_Loading(false, 1);
                }
                js_Loading(false, 1);
            },
            error: function () {
                js_Loading(false, 1);
            }
        });
    }

</script>